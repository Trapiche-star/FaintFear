using UnityEngine;

namespace FaintFear
{
    /// <summary>
    /// ìŠ¤íƒ€íŠ¸ íŠ¸ë¦¬ê±° ë‚´ë¶€ í¬ì¸íŠ¸ ë¼ì´íŠ¸ ì¡°ì ˆ
    /// </summary>
    public class LightZone01 : MonoBehaviour
    {
        [Header("ê±´ë¬¼ ë‚´ë¶€ ëª¨ë“  Point Lightê°€ ë“¤ì–´ìˆëŠ” ë¶€ëª¨ ì˜¤ë¸Œì íŠ¸")]
        public GameObject allPointLights; // AllPointLight ì˜¤ë¸Œì íŠ¸ë¥¼ ë“œë˜ê·¸í•´ì„œ ì—°ê²°

        [Header("íŠ¸ë¦¬ê±° ì•ˆì¼ ë•Œ ë¹›ì´ ë‹¿ëŠ” ìµœëŒ€ ë²”ìœ„ (Range)")]
        public float activeRange = 8f; // ë¼ì´íŠ¸ê°€ ì¼œì¡Œì„ ë•Œ Range ê°’

        [Header("íŠ¸ë¦¬ê±° ë°–ì¼ ë•Œ Range (ë¹›ì´ ì•ˆ í¼ì§€ê²Œ 0ìœ¼ë¡œ ë‘ë©´ ë¨)")]
        public float inactiveRange = 0f; // ë¼ì´íŠ¸ê°€ êº¼ì¡Œì„ ë•Œ Range ê°’

        [Header("ë¼ì´íŠ¸ê°€ ì¼œì§ˆ ìˆ˜ ìˆëŠ” ìµœëŒ€ ê±°ë¦¬ (íŠ¸ë¦¬ê±° ì¤‘ì‹¬ ê¸°ì¤€)")]
        public float triggerLightDistance = 15f; // íŠ¸ë¦¬ê±° ì¤‘ì‹¬ìœ¼ë¡œë¶€í„° ì¼ì • ê±°ë¦¬ ì•ˆì˜ ë¼ì´íŠ¸ë§Œ ì¼œì§

        // AllPointLight ìì‹ì— ìˆëŠ” Light ì»´í¬ë„ŒíŠ¸ë“¤ì„ ë‹´ì„ ë°°ì—´
        private Light[] lights;

        void Start()
        {
            // allPointLightsê°€ ë¹„ì–´ ìˆì§€ ì•Šë‹¤ë©´ (Inspectorì—ì„œ ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´)
            // í•´ë‹¹ ì˜¤ë¸Œì íŠ¸ì˜ ëª¨ë“  ìì‹ ì¤‘ Light ì»´í¬ë„ŒíŠ¸ë¥¼ ì°¾ì•„ì„œ ë°°ì—´ì— ì €ì¥
            if (allPointLights != null)
                lights = allPointLights.GetComponentsInChildren<Light>();

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // ğŸ” ì”¬ì´ ì‹œì‘ë  ë•Œ, Playerê°€ ì´ë¯¸ íŠ¸ë¦¬ê±° ì•ˆì— ìˆëŠ”ì§€ë¥¼ ê²€ì‚¬í•˜ëŠ” ë¶€ë¶„
            // Physics.OverlapBoxëŠ” ì§€ì •í•œ ìœ„ì¹˜/í¬ê¸°/íšŒì „ ë²”ìœ„ ì•ˆì— ë“¤ì–´ìˆëŠ” ëª¨ë“  Colliderë¥¼ ë°˜í™˜í•¨
            // transform.position : í˜„ì¬ íŠ¸ë¦¬ê±° ì˜¤ë¸Œì íŠ¸ì˜ ì¤‘ì‹¬ ì¢Œí‘œ
            // GetComponent<BoxCollider>().size / 2 : Colliderì˜ ë°˜ í¬ê¸°(ì ˆë°˜ ì‚¬ì´ì¦ˆ)
            // transform.rotation : í˜„ì¬ íšŒì „ê°’ ìœ ì§€
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            Collider[] colliders = Physics.OverlapBox(
                transform.position,
                GetComponent<BoxCollider>().size / 2,
                transform.rotation
            );

            // ë°˜í™˜ëœ ëª¨ë“  Colliderë“¤ì„ í•˜ë‚˜ì”© ê²€ì‚¬
            foreach (Collider col in colliders)
            {
                // ê°ì§€ëœ Collider ì¤‘ì— íƒœê·¸ê°€ "Player"ì¸ ê²Œ ìˆë‹¤ë©´
                if (col.CompareTag("Player"))
                {
                    // ğŸ”† ì´ë¯¸ Playerê°€ íŠ¸ë¦¬ê±° ì•ˆì— ìˆìœ¼ë¯€ë¡œ ë¼ì´íŠ¸ë¥¼ ì¼ ë‹¤
                    SetLightsActive(true);

                    // Playerë¥¼ ì°¾ì•˜ìœ¼ë‹ˆ ë” ì´ìƒ ê²€ì‚¬í•  í•„ìš” ì—†ì–´ì„œ í•¨ìˆ˜ ì¢…ë£Œ
                    return;
                }
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // ì—¬ê¸°ê¹Œì§€ ì™”ë‹¤ëŠ” ê±´ Playerê°€ íŠ¸ë¦¬ê±° ì•ˆì— ì—†ë‹¤ëŠ” ëœ»
            // ë”°ë¼ì„œ ëª¨ë“  ë¼ì´íŠ¸ë¥¼ êº¼ë‘”ë‹¤
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            SetLightsActive(false);
        }

        // í”Œë ˆì´ì–´ê°€ íŠ¸ë¦¬ê±° ì˜ì—­ì— ë“¤ì–´ì™”ì„ ë•Œ í˜¸ì¶œë¨
        private void OnTriggerEnter(Collider other)
        {
            // "Player" íƒœê·¸ê°€ ë¶™ì€ ì˜¤ë¸Œì íŠ¸ì¼ ë•Œë§Œ ë°˜ì‘
            if (other.CompareTag("Player"))
            {
                // ë¼ì´íŠ¸ ì¼œê¸°
                SetLightsActive(true);
            }
        }

        // í”Œë ˆì´ì–´ê°€ íŠ¸ë¦¬ê±° ì˜ì—­ì—ì„œ ë‚˜ê°”ì„ ë•Œ í˜¸ì¶œë¨
        private void OnTriggerExit(Collider other)
        {
            if (other.CompareTag("Player"))
            {
                // ë¼ì´íŠ¸ ë„ê¸°
                SetLightsActive(false);
            }
        }

        // ë¼ì´íŠ¸ ìƒíƒœë¥¼ ì¼ê´„ë¡œ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
        private void SetLightsActive(bool state)
        {
            // lights ë°°ì—´ì´ ë¹„ì–´ìˆìœ¼ë©´ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ (Null ë°©ì§€)
            if (lights == null) return;

            // íŠ¸ë¦¬ê±° ì¤‘ì‹¬ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°
            Vector3 triggerCenter = transform.position;

            // ëª¨ë“  ë¼ì´íŠ¸ì— ëŒ€í•´ ë°˜ë³µ
            foreach (Light l in lights)
            {
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ê° ë¼ì´íŠ¸ì™€ íŠ¸ë¦¬ê±° ì¤‘ì‹¬ ì‚¬ì´ì˜ ê±°ë¦¬ ê³„ì‚°
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                float distance = Vector3.Distance(l.transform.position, triggerCenter);

                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                // ë§Œì•½ ë¼ì´íŠ¸ê°€ íŠ¸ë¦¬ê±° ë²”ìœ„(triggerLightDistance) ì•ˆì— ìˆì„ ê²½ìš°ë§Œ ì¼œê¸°
                // ê·¸ ë°–ì˜ ë¼ì´íŠ¸ëŠ” í•­ìƒ êº¼ë‘ê¸°
                // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (state && distance <= triggerLightDistance)
                {
                    // íŠ¸ë¦¬ê±° ì•ˆ + ê±°ë¦¬ ì•ˆ â†’ ë¼ì´íŠ¸ ì¼œê¸°
                    l.enabled = true;
                    l.range = activeRange;
                }
                else
                {
                    // íŠ¸ë¦¬ê±° ë°–ì´ê±°ë‚˜ ë„ˆë¬´ ë¨¼ ë¼ì´íŠ¸ â†’ ë„ê¸°
                    l.enabled = false;
                    l.range = inactiveRange;
                }
            }
        }
    }
}
